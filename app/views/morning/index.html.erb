<div class="morning">
  <h1>The Morning Show</h1>
  <div class="meta">
    Showing <%= @plays.size %> plays • Last updated <%= Time.current.strftime('%Y-%m-%d %H:%M') %>
  </div>
  <div class="actions">
    <%= button_to "Refresh Today",
          refresh_morning_index_path,
          method: :post,
          class: "btn btn-refresh" %>
    <%= button_to "Backfill Last 30 Days",
          backfill_morning_index_path(days: 30),
          method: :post,
          class: "btn btn-danger" %>
  </div>
  <%# ——— Tiny backfill status line (smart show/hide) ——— %>
  <% if @last_backfill.present? %>
    <% age_time = @last_backfill.finished_at || @last_backfill.started_at %>
    <% recent   = age_time && age_time > 6.hours.ago %>
    <% show_it  = @last_backfill.status != "success" || recent %>
    <% if show_it %>
      <div class="job-status <%= @last_backfill.status %>">
        <% icon = { "running"=>"⏳", "success"=>"✅", "failed"=>"⚠️" }[@last_backfill.status] %>
        <span class="icon"><%= icon %></span>
        <span class="label">Last update:</span>
        <% if @last_backfill.status == "running" %>
          <span class="state">Running</span>
          <span class="time">• started <%= time_ago_in_words(age_time) %> ago</span>
        <% elsif @last_backfill.status == "success" %>
          <span class="state">Success</span>
          <% if @last_backfill.imported_count.to_i > 0 %>
            <span class="count">• imported <%= @last_backfill.imported_count %></span>
          <% end %>
          <span class="time">• finished <%= time_ago_in_words(age_time) %> ago</span>
        <% else %>
          <span class="state">Failed</span>
          <span class="time">• <%= time_ago_in_words(age_time) %> ago</span>
          <% if @last_backfill.error_message.present? %>
            <span class="err">• <%= @last_backfill.error_message %></span>
          <% end %>
        <% end %>
      </div>
    <% end %>
  <% end %>
  <% if notice %>
    <p class="notice"><%= notice %></p>
  <% end %>
  <% if alert %>
    <p class="alert"><%= alert %></p>
  <% end %>
  <!-- Top 40 (Turbo frame; includes its own header + period buttons) -->
  <%= turbo_frame_tag "top40" do %>
    <%= render partial: "top40", locals: {
          top_songs:         @top_songs,
          period:            @period,
          period_label:      @period_label,
          period_play_count: @period_play_count,
          years:             @years
        } %>
  <% end %>
  <!-- Recent plays -->
  <h2>Recent Plays</h2>
  <div class="scroll-box">
    <% if @plays.present? %>
      <table class="recent-plays">
        <thead>
          <tr>
            <th>Time (PT)</th>
            <th>Artist</th>
            <th>Song</th>
            <th>Album</th>
          </tr>
        </thead>
        <tbody>
          <% @plays.each do |p| %>
            <tr>
              <td><%= p.played_at&.in_time_zone('Pacific Time (US & Canada)')&.strftime('%Y-%m-%d %H:%M') %></td>
              <td><%= p.artist %></td>
              <td><%= p.song %></td>
              <td><%= p.album %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No recent plays found yet. Try refreshing or backfilling.</p>
    <% end %>
  </div>
</div>
